<html>
<head>
  <title></title>
  <link rel="stylesheet" type="text/css" href="../xhelpfrms.css">
</head>

<body>
<!--#include virtual="/header_en.html"-->

<h2>Admin scripts</h2>
This manual covers helper scripts for the Mix server, an InfoService, a
firewall and a web proxy. They are useful if you often want to update the code
with the newest CVS version. We also propose Operators to encrypt their server
file system before installation. 

<p><em>Hint: Normal Mix Operators do not need to install an InfoService. This
is planned for the future.</em></p>

<h3>Directories</h3>
To run the mix (and optionally an InfoService) you have to create the following
directories: 

<blockquote>
  <code>/home/mix/Mixproxy </code>binaries and configuration for Mix server<br>
  <code>/home/mix/InfoService </code>binaries and configuration for
  InfoService<br>
  <code>/home/mix/InfoService/log </code>Status statistics of InfoService<br>
</blockquote>
To create a directory, type 

<blockquote>
  <code>mkdir [directory name] </code> </blockquote>
In each of the directories the subdirectories 

<blockquote>
  <code>./backup</code><br>
  <code>./cvs</code><br>
</blockquote>
will be generated by the scripts.<code>./backup</code> holds old binaries and
their log files. As you see you may easily go back to an old but working
installation if an update has failed. In <code>./cvs</code> the source files
are stored (and overwritten) when getting a new source code version. 

<h3>Executables</h3>
Please put the following executable files in the proper directories. Note that
the InfoService files are optional. There is also a firewall script, but if you
want to use it, you will have to adapt it to your needs first. 
<dl>
  <dt><a href="runANONServer">/home/mix/runANONServer</a></dt>
    <dd>common script to start, shutdown update and monitor the Mix and the
      InfoService</dd>
  <dt><a href="rc.status.anon">/home/mix/rc.status.anon</a></dt>
    <dd>script for printing status messages</dd>
  <dt>/home/mix/Mixproxy/mix</dt>
    <dd>Mix server binary</dd>
  <dt><a href="Mixproxy/runMixproxy">/home/mix/Mixproxy/runMixproxy</a></dt>
    <dd>script to start, shutdown update and monitor the Mix</dd>
  <dt>/home/mix/InfoService/InfoService.jar</dt>
    <dd>InfoService executable jar</dd>
  <dt><a
  href="InfoService/runInfoService">/home/mix/InfoService/runInfoService</a></dt>
    <dd>script to start, shutdown update and monitor the InfoService</dd>
  <dt><a href="firewall">/home/mix/firewall</a></dt>
    <dd>script to start and shutdown your firewall</dd>
  <dt><a href="squidconfigure">/home/mix/squidconfigure</a></dt>
    <dd>configure script for optimizing the squid 2.6 compilation </dd>
</dl>
Make sure that each of these file is really executable by typing 

<blockquote>
  <code>chmod -R /home/mix/* +x</code> </blockquote>

<p>You might also need to convert the executable files to the unix format by
installing the <em>sysutils</em> or <em>tofrodos</em> package</p>

<p>e.g. with apt by</p>

<blockquote>
  <code>apt-get update<br>
  apt-get install tofrodos </code> </blockquote>

<p>and typing </p>

<blockquote>
  <code>dos2unix &lt;filename&gt; </code> </blockquote>
on each of the files. 

<h3>Config files</h3>
For running the mix, you only need the config file generated by the MixConfig
tool. Please name and place the config files as shown below, otherwise you will
have to adapt one or more of the executable scripts and the links to them. 
<dl>
  <dt>/home/mix/Mixproxy/config.xml</dt>
    <dd>config file for the Mix server</dd>
  <dt>/home/mix/InfoService/Infoservice.properties</dt>
    <dd>config file for the Mix server</dd>
  <dt><a href="squid.conf">/home/mix/squid.conf</a></dt>
    <dd>config file for squid proxy </dd>
  <dt><a href="squid-block.acl">/home/mix/squid-block.acl</a></dt>
    <dd>a file containing blocked websites </dd>
</dl>

<h3>Squid proxy installation (for last mixes) </h3>

<p>Download the newest squid 2.6 stable sourcecode from </p>

<blockquote>
  <a
  href="http://www.squid-cache.org/Versions/v2/2.6/">http://www.squid-cache.org/Versions/v2/2.6/</a>
</blockquote>

<p>and unpack to /home/mix by typing</p>

<blockquote>
  <code>tar xzf squid-2.6.STABLE6.tar.gz </code> </blockquote>

<p>Copy the executable <a href="squidconfigure">squidconfigure</a> into the
newly created directory squid-2.6.STABLE6 and type</p>

<blockquote>
  <code>./squidconfigure </code><br>
  <code>make </code><br>
  <code>make install </code></blockquote>

<p>Squid is now installed in /usr/local/squid. Link the squid executable to
/usr/sbin</p>

<blockquote>
  <code>ln -s /usr/local/squid/sbin/squid /usr/sbin/squid</code><br>
  <code>mv /usr/local/squid/etc/squid.conf
  </code><code>/usr/local/squid/etc/squid.conf~</code><br>
  <code>ln -s /home/mix/squid.conf /usr/local/squid/etc/squid.conf</code><br>
  <code>ln -s /home/mix/squid-block.acl /usr/local/squid/etc/squid-block.acl
  </code></blockquote>
Create the cache files 

<blockquote>
  <code>mkdir /var/spool/squid</code><br>
  <code>chown proxy:proxy /var/spool/squid</code><br>
  <code>squid -z -d 3 </code><br>
</blockquote>

<p>and start squid:</p>

<blockquote>
  <code>ulimit -HSn 64000 </code><br>
  <code>squid </code></blockquote>

<h3>InfoService Libraries</h3>
If you plan to run an InfoService, too, you need to copy the java libraries
needed for compilation into the directory 

<blockquote>
  <code>/home/mix/InfoService/lib</code> </blockquote>
If you choose an other directory, you have to adapt the file
<code>/home/mix/InfoService/runInfoService</code>. 

<p>For installing a java compiler and a runtime environment, you will find a
very good installation guide for debian <a
href="http://wiki.serios.net/wiki/Debian_Java_JRE/JDK_installation_from_APT_repositories"
target="_blank">here </a>. As this does not seem to work at the moment, try <a
href="http://www.crazysquirrel.com/computing/debian/java.jspx"
target="_blank">this</a>. Soon Sun Java will be integrated into Debian stable,
as Sun has changed its licence., and may then be easily installed. If you have
several Java versions installed on your system, you can switch between them by
typing</p>

<blockquote>
  <code>sudo update-alternatives --config java</code></blockquote>

<h3>Links to the executables</h3>
You should set some system-wide links, so that you can use the startup scripts
from every directoy: 

<blockquote>
  <code>su </code><br>
  <code>ln -s /home/mix/firewall /usr/bin/firewall </code><br>
  <code>ln -s /home/mix/Mixproxy/runMixproxy /usr/bin/mixproxy </code><br>
  <code>ln -s /home/mix/InfoService/runInfoService /usr/bin/infoservice
  </code><br>
  <code>exit </code><br>
</blockquote>

<p>Before Mix compilation, may need to install some packages in order to
compile the code: </p>
<ul>
  <li>cvs </li>
  <li>g++</li>
  <li>gcc</li>
  <li>gpp</li>
  <li>make</li>
  <li>automake</li>
  <li>postgresql</li>
  <li>postgresql-dev or libpq-dev (might other names on different systems)</li>
  <li>libssl-dev</li>
  <li>libxerces27-dev (or newer) </li>
</ul>

<p>and dependencies. If you do not find one or more of these libraries, you
may, on Debian/Ubuntu systems, look for them using the <code>apt-cache
search</code> command<code>.</code></p>

<p>You may now update the mix with the newest CVS code by typing</p>

<blockquote>
  <code>mixproxy cvs compile update</code></blockquote>

<h3>Accounting database configuration</h3>

<p>If you run pay Mixes, you moreover have to initialise the postgres database.
it is only needed for the first Mix. However, you do not know if you may not
switch position some time, and therefore also other Mixes should do that. </p>
<ol>
  <li><code>su postgres</code> (switches to user <code>postgres</code>)</li>
  <li><code>createuser -A -D aiuser</code> (creates the new user
    <code>aiuser</code>)</li>
  <li><code>createdb -O aiuser aidb</code> (creates the accounting
  database)</li>
  <li><code>psql -d aidb</code> (logs you into the database environment as user
    <code>postgres</code>)</li>
  <li><code>alter user aiuser with password 'PASSWORD';</code> (set the
    password for this user)</li>
  <li><code>\q</code> (leave the database environment)</li>
  <li>Edit the postgres configuration file <code>pg_hba.conf</code> located
    somewhere in <code>/etc/postgresql</code> and allow connections with
    password. Replace the commands there that enforce <code>ident</code> or
    <code>md5</code> login. Note that Postgres looks only for the first line
    matching a connection type, so don't insert several lines for the same
    connection type. 
    <p><code># All other connections by UNIX sockets</code></p>
    <p><code>local all all password</code></p>
    <p><code># All IPv4 connections from localhost</code></p>
    <p><code>host all all 127.0.0.1 255.255.255.255 ident
    password&#x15f;</code></p>
  </li>
  <li>Restart postgres (often done by <code>/etc/init.d/postgresql
    restart</code> or similar commands)</li>
  <li><code>psql -U aiuser -d aidb &lt;
    /home/mix/Mixproxy/cvs/proxytest/mixtables.sql</code> (Fill the accounting
    database with the accounting tables)</li>
  <li><code>psql -U aiuser -d aidb</code> (Login as aiuser with your
  password)</li>
  <li><code>\dt</code> Check if you see the created tables or not... If you do,
    everything is OK!)</li>
  <li><code>\q</code> (logout)</li>
  <li><code>exit</code> (switch back to your local user)</li>
</ol>

<h3>Start/Stop/Restart</h3>

<p>The Mix server, InfoService and the firewall can be started with running the
skripts with the 'start', 'stop' and 'restart' options. With the 'process'
option you can list the running processes, 'log' will list the log file
entries. 'status' H&#xe4;ufigkeit:- alle paar Wochenshows you if the servers
are running at the moment. </p>

<p>You can test if the Mix server has connected properly to a cascade by tying
</p>

<blockquote>
  <code>mixproxy process</code> </blockquote>

<p>If you see more than one running instance of the server process, everythin
is OK. This can take about a minute after you started the Mix. Another
indication is to check at the end of the logfile for an entry "connected" by
typing </p>

<blockquote>
  <code>mixproxy log | less</code> </blockquote>

<p>and after the log file has opened </p>

<blockquote>
  <code>Shift+G</code> </blockquote>

<p>The firewall has to be started with 'root' rights. If you do not have 'root'
rights it's normally also ok to restart the system. This will automatically
also restart the firewall with 'root' privileges. </p>

<h3>Runlevel links</h3>
If you want the services started automatically when starting the server
machine, you have to set links to the executables in runlevel 3 and runlevel 5. 

<blockquote>
  <code>su </code><br>
  <code>ln - s /home/mix/firewall /etc/init.d/firewall </code><br>
  <code>ln - s /home/mix/Mixproxy/runMixproxy /etc/init.d/mixproxy </code><br>
  <code>ln - s /home/mix/InfoService/runInfoService /etc/init.d/infoservice
  </code><br>
  <code>exit </code> </blockquote>

<h3>Log files</h3>
New messages will be appended on the end of the logfiles. InfoService can have
more than just one logfile but should be configured with just one central log.
Please configure the Mix/InfoService to store its logs at those positions: 

<blockquote>
  <code>/var/log/messages </code>messages / logging of your firewall<code><br>
  /home/mix/Mixproxy/messages </code>messages / logging of the Mix
  server<code><br>
  /home/mix/InfoService/InfoService.log </code>messages / logging of
  InfoService<code><br>
  /home/mix/InfoService/log/ </code>status logs of your cascade<code><br>
  </code> </blockquote>

<h3>Default runlevel</h3>
The default runlevel has been set to 3 so that the the graphical environment
will not be loaded. This can be changed by the administrator either while the
system is running with: 

<blockquote>
  <code>init 5 </code> </blockquote>
or permanently with editing the <code>/etc/inittab</code> entries. <!--#include virtual="/footer_en.html"-->
 </body>
</html>
