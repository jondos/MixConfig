<html>
<head>
  <title></title>
  <link rel="stylesheet" type="text/css" href="../xhelpfrms.css">
</head>

<body>
<!--#include virtual="/header_en.html"-->

<h2>Howto: Compile and run a Mix server on Linux/UNIX with administration
scripts</h2>
This manual covers helper scripts for the Mix server and a web proxy, and the
installation of a web/http and socks proxy. They are useful if you want to
automatically update your code instead of doing a lot of hand-work on each
update. 

<h3>Preparing the server</h3>
<ul>
  <li><strong>Encrypt the file system of your server</strong> 
    <p>We propose Operators to encrypt their server file system before
    installation. This will prevent an automatic restart of your server, but
    gives you some protection from possibly manipulating server hosters.</p>
  </li>
  <li><strong>Stop and uninstall all other network services</strong> 
    <p>Stop all services that accept connections from the internet. Only SSH
    and the Mix process should listen to outside connections. (If you do not
    understand these terms, you should better not run a Mix).</p>
  </li>
  <li><strong>Protect your server against brute force login attacks</strong> 
    <p>For making it harder to hack your server login, use SSH certificates for
    login or install login protection software like fail2ban or
    portknocking.</p>
  </li>
</ul>

<h3>Directories</h3>

<p>To run the mix you should create the following directories: </p>

<blockquote>
  <code>/home/mix/Mixproxy </code>binaries and configuration for Mix server<br>
</blockquote>
To create a directory, type 

<blockquote>
  <code>mkdir [directory name] </code> </blockquote>
In each of the directories the subdirectories 

<blockquote>
  <code>./backup</code><br>
  <code>./cvs</code><br>
</blockquote>
will be generated by the scripts.<code>./backup</code> holds old binaries and
their log files. As you see you may easily go back to an old but working
installation if an update has failed. In <code>./cvs</code> the source files
are stored (and overwritten) when getting a new source code version. 

<h3>Executables</h3>
Please put the following executable files in the proper directories. Note that
the InfoService files are optional. There is also a firewall script, but if you
want to use it, you will have to adapt it to your needs first. 
<dl>
  <dt><a href="runANONServer">/home/mix/runANONServer</a></dt>
    <dd>common script to start, shutdown update and monitor the Mix and the
      InfoService</dd>
  <dt><a href="rc.status.anon">/home/mix/rc.status.anon</a></dt>
    <dd>script for printing status messages</dd>
  <dt>/home/mix/Mixproxy/mix</dt>
    <dd>Mix server binary</dd>
  <dt><a href="Mixproxy/runMixproxy">/home/mix/Mixproxy/runMixproxy</a></dt>
    <dd>script to start, shutdown update and monitor the Mix</dd>
  <dt><a href="squidconfigure">/home/mix/squidconfigure</a></dt>
    <dd>configure script for optimizing the squid 2.6 compilation </dd>
</dl>
Make sure that each of these file is really executable by typing 

<blockquote>
  <code>chmod -R /home/mix/* +x</code> </blockquote>

<p>You might also need to convert the executable files to the unix format by
installing the <em>sysutils</em> or <em>tofrodos</em> package</p>

<p>e.g. with apt by</p>

<blockquote>
  <code>apt-get update<br>
  apt-get install tofrodos </code> </blockquote>

<p>and typing </p>

<blockquote>
  <code>dos2unix &lt;filename&gt; </code> </blockquote>
on each of the files. 

<h3>Config files</h3>
For running the mix, you only need the config file (typically named config.xml)
generated by the MixConfig tool. Please name and place the config files as
shown below, otherwise you will have to adapt one or more of the executable
scripts and the links to them. 
<dl>
  <dt>/home/mix/Mixproxy/config.xml</dt>
    <dd>config file for the Mix server</dd>
  <dt><a href="squid.conf">/home/mix/squid.conf</a></dt>
    <dd>config file for squid proxy </dd>
  <dt><a href="squid-block.acl">/home/mix/squid-block.acl</a></dt>
    <dd>a file containing blocked websites </dd>
  <dt><a href="danted.conf">/home/mix/danted.conf</a></dt>
    <dd>configuration file for dante SOCKS server, also containing blocked
      websites </dd>
</dl>

<h3>Squid proxy installation (for last mixes) </h3>

<p>Download the newest squid 2.6 stable sourcecode from </p>

<blockquote>
  <a
  href="http://www.squid-cache.org/Versions/v2/2.6/">http://www.squid-cache.org/Versions/v2/2.6/</a>
</blockquote>

<p>and unpack to /home/mix by typing</p>

<blockquote>
  <code>tar xzf squid-2.6.STABLE6.tar.gz </code> </blockquote>

<p>Copy the executable <a href="squidconfigure">squidconfigure</a> into the
newly created directory squid-2.6.STABLE6 and type</p>

<blockquote>
  <code>./squidconfigure </code><br>
  <code>make </code><br>
  <code>make install </code></blockquote>

<p>Squid is now installed in /usr/local/squid. Link the squid executable to
/usr/sbin</p>

<blockquote>
  <code>ln -s /usr/local/squid/sbin/squid /usr/sbin/squid</code><br>
  <code>mv /usr/local/squid/etc/squid.conf
  </code><code>/usr/local/squid/etc/squid.conf~</code><br>
  <code>ln -s /home/mix/squid.conf /usr/local/squid/etc/squid.conf</code><br>
  <code>ln -s /home/mix/squid-block.acl /usr/local/squid/etc/squid-block.acl
  </code></blockquote>
Create the cache files 

<blockquote>
  <code>mkdir /var/spool/squid</code><br>
  <code>chown proxy:proxy /var/spool/squid</code><br>
  <code>squid -z -d 3 </code><br>
</blockquote>

<p>and start squid:</p>

<blockquote>
  <code>ulimit -HSn 64000 </code><br>
  <code>squid </code></blockquote>

<h3>Dante SOCKS server installation (for last Premium Mixes)</h3>

<p>Dante is a SOCKS server you may add to your last Mix BESIDES squid. Squid is
still necessary, but dante will add more features to your Mix.</p>

<p>For installation with apt, this command should be sufficient:</p>

<p><code>apt-get install dante-server</code></p>

<p>For non-Debian-Systems, you might have to use a non-apt package</p>

<p><a href="ftp://ftp.inet.no/pub/socks/dante-1.1.19.tar.gz">Download Dante
1.1.9 (FTP)</a> (<a href="ftp://ftp.inet.no/pub/socks/">or try the general
download directory</a>)</p>

<p>For Debian Lenny, this trick might work:</p>

<p><a
href="http://forums.debian.net/viewtopic.php?p=200782&amp;sid=0ac40513a6bd89bbb5b052640ae09253">http://forums.debian.net/viewtopic.php?p=200782&amp;sid=0ac40513a6bd89bbb5b052640ae09253</a></p>

<p>Now you may use the prepared configuration. It will block outgoing mail
ports to prevent spam. If you do not care about that, you may open them,
though. The configuration also contains the list of blocked web sites (for the
squid configuration, this is a separate list, not so for dante).</p>

<p><code>mv /etc/danted.conf </code><code>/etc/danted.conf~</code><br>
<code>ln -s /home/mix/danted.conf /etc/danted.conf</code><br>
</p>

<p>Please edit the danted.conf so that your exit IP address is marked as
external, e.g.</p>

<p><code>external: 87.230.20.185 </code>(This is the example
entry)<code></code></p>

<p>Otherwise dante will not start. Then you should start or restart the dante
server:</p>

<p><code>/etc/init.d/danted restart</code></p>

<p><strong>Please note: You will have to <a
href="../mixconfig.OtherMixPanel_en.html">edit the Mix configuration</a> and
restart the Mix before it can use the Dante server.</strong></p>

<h3>Link to the executable</h3>
You should set some system-wide links, so that you can use the startup scripts
from every directoy: 

<blockquote>
  <code>su </code><br>
  <code>ln -s /home/mix/Mixproxy/runMixproxy /usr/bin/mixproxy </code><br>
  <code>exit </code><br>
</blockquote>

<p>Before Mix compilation, may need to install some packages in order to
compile the code: </p>
<ul>
  <li>cvs </li>
  <li>g++</li>
  <li>gcc</li>
  <li>gpp</li>
  <li>make</li>
  <li>automake</li>
  <li>postgresql</li>
  <li>postgresql-dev or libpq-dev (might other names on different systems)</li>
  <li>libssl-dev</li>
  <li>libxerces27-dev (or newer) </li>
</ul>

<p>and dependencies. If you do not find one or more of these libraries, you
may, on Debian/Ubuntu systems, look for them using the <code>apt-cache
search</code> command<code>.</code></p>

<p>If you do not run a Premium Mix but only a free one, please remove the
respective compile command "<code>--enable-payment</code>" from the
<code>runMixproxy</code> script first:</p>

<p><code>...</code></p>

<p><code>export COMPILE_OPTIONS="--enable-payment
--enable-server_monitoring"</code></p>

<p><code>...</code></p>

<p>You may now update the mix with the newest CVS code by typing</p>

<blockquote>
  <code>mixproxy cvs compile update</code></blockquote>

<h3>Troubleshooting</h3>

<p>If, for some reason, the scripts do not work on your system, you should
first check the script options in <code>runMixproxy</code>.</p>
<ul>
  <li>COMPILE_OPTIONS 
    <p>Maybe you find some unnecessary options here? if you do not run a
    Premium Mix, you have to remove the option <code>--enable-payment</code>,
    for example.</p>
  </li>
  <li>CVS_DATE 
    <p>Maybe you forgot to comment this option? If CVS_DATE is uncommented, the
    scripts will fetch the code for a specific date. That means that you will
    not necessarily get the latest code. You might want to put a <code>#</code>
    before this line to comment it out, like</p>
    <p># CVS_DATE...</p>
    <p>The date command is useful when you would like to stick to a stable
    version until the next one comes out.</p>
  </li>
</ul>

<p>If this does not help, you may try the following:</p>
<ul>
  <li><a href="../mixsetupBuildGetSources_en.html">download the sourcecode
    using pure cvs commands</a></li>
  <li><a href="mixsetupBuildCompile_en.html">compile the sources "by
  hand"</a></li>
</ul>

<h3>Accounting database configuration</h3>

<p>If you run pay Mixes, you moreover have to initialise the postgres database.
it is only needed for the first Mix. However, you do not know if you may not
switch position some time, and therefore also other Mixes should do that. </p>
<ol>
  <li><code>su postgres</code> (switches to user <code>postgres</code>)</li>
  <li><code>createuser -A -D aiuser</code> (creates the new user
    <code>aiuser</code>)</li>
  <li><code>createdb -O aiuser aidb</code> (creates the accounting
  database)</li>
  <li><code>psql -d aidb</code> (logs you into the database environment as user
    <code>postgres</code>)</li>
  <li><code>alter user aiuser with password 'PASSWORD';</code> (set the
    password for this user)</li>
  <li><code>\q</code> (leave the database environment)</li>
  <li>Edit the postgres configuration file <code>pg_hba.conf</code> located
    somewhere in <code>/etc/postgresql</code> and allow connections with
    password. Replace the commands there that enforce <code>ident</code> or
    <code>md5</code> login. Note that Postgres looks only for the first line
    matching a connection type, so don't insert several lines for the same
    connection type. 
    <p><code># All other connections by UNIX sockets</code></p>
    <p><code>local all all password</code></p>
    <p><code># All IPv4 connections from localhost</code></p>
    <p><code>host all all 127.0.0.1 255.255.255.255 ident
    password&#x15f;</code></p>
  </li>
  <li>Restart postgres (often done by <code>/etc/init.d/postgresql
    restart</code> or similar commands)</li>
  <li><code>psql -U aiuser -d aidb &lt;
    /home/mix/Mixproxy/cvs/proxytest/mixtables.sql</code> (Fill the accounting
    database with the accounting tables)</li>
  <li><code>psql -U aiuser -d aidb</code> (Login as aiuser with your
  password)</li>
  <li><code>\dt</code> Check if you see the created tables or not... If you do,
    everything is OK!)</li>
  <li><code>\q</code> (logout)</li>
  <li><code>exit</code> (switch back to your local user)</li>
</ol>

<h3>Log files</h3>

<p>New messages will be appended on the end of the logfiles. Please configure
the Mix to store its logs at those positions: </p>

<blockquote>
  <code>/home/mix/Mixproxy/messages </code>messages / logging of the Mix server
</blockquote>

<p>Please note: if you have configured the Mix to use the Syslog only, no
messages will be stored in this file.</p>

<h3>Start/Stop/Restart</h3>

<p>The mix has to be started with 'root' rights if it should listen on ports
lower than 1024. Start the process by running the skripts with the 'start',
'stop' and 'restart' options. With the 'process' option you can list the
running processes, 'log' will list the log file entries. 'status' shows you if
the Mix process is currently running. </p>

<p>You can test if the Mix process has started by typing </p>

<blockquote>
  <code>mixproxy status</code> </blockquote>

<p>If the status is "running", the configuration could be parsed and the Mix
process has started so far. </p>

<p>If you expect your Mix to connect to other Mixes now, you should now check
the logfile for an entry "connected" by typing </p>

<blockquote>
  <code>mixproxy log | grep connected</code></blockquote>

<p>If you do not find this entry, you could further examine the log files, for
example by typing</p>

<blockquote>
  <code>mixproxy log | less</code></blockquote>

<p>and after the log file has opened </p>

<blockquote>
  <code>Shift+G</code> </blockquote>

<h3>Troubleshooting</h3>

<p>If your Mix does not start by using the scripts, you maybe should start it
"by hand"</p>
<ul>
  <li>got to the directory where the Mix is located 
    <p><code>cd /home/mix/Mixproxy</code></p>
  </li>
  <li>execute this command 
    <p><code>./mix --config=config.xml</code></p>
  </li>
</ul>

<p>If the Mix starts, but takes much more than a minute for the connection,
this usually has one of the following reasons:</p>
<ul>
  <li>If the Mix tries to connect but always gets a timeout, then either the
    Mixes bad connections to each other, the next/previous Mixes are currently
    not running or you have entered the wrong port for a connection to the next
    Mix. Please try a telnet connection on the expected listen port of your
    next mix.</li>
  <li>You Mix listens on the wrong port(s). Please tell the Operator of the
    previous Mix to make a telnet connection to your Mix port, just to make
    sure that he really connects to your port(s).</li>
  <li>The shared Mix certificates between your Mix and the next/previous Mix
    may be wrong. Please verify that you really have the right next/previous
    certificates in your configuration, and that you are really starting the
    Mix with its current certificate. To do this, use the config tool for
    reading the certificates and comparing their hash values with those that
    the other operators have.</li>
</ul>

<h3>Runlevel links</h3>

<p>If you want the services started automatically when starting the server
machine, you have to set links to the executables in runlevel 3 and runlevel 5.
Please note that this will only work if you have not set a password for your
Mix certificate.</p>

<blockquote>
  <code>su </code><code></code><br>
  <code>ln - s /home/mix/Mixproxy/runMixproxy /etc/init.d/mixproxy</code><br>
  <code>exit </code> </blockquote>

<h3>Default runlevel</h3>
The default runlevel has been set to 3 so that the the graphical environment
will not be loaded. This can be changed by the administrator either while the
system is running with: 

<blockquote>
  <code>init 5 </code> </blockquote>
or permanently with editing the <code>/etc/inittab</code> entries. <!--#include virtual="/footer_en.html"-->
 </body>
</html>
